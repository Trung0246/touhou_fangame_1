#TouhouDanmakufu[Single]
#ScriptVersion[3]
#Title["Boss testing"]
#Text["feat. dangerous ocean fairy"]

#include "script/main/script/lib/DarkShotconstants.dnh"
#include"script/default_system/Default_Effect.txt"

let objBoss;
@Initialize
{
	objBoss = ObjEnemy_Create(OBJ_ENEMY_BOSS);
	ObjEnemy_Regist(objBoss);
	TWork;
	Animation_Azure(objBoss);
	TEnd;

	DeleteShotAll(TYPE_ALL, TYPE_ITEM);
}

@MainLoop
{
	yield;
}

@Event
{
	alternative(GetEventType())
	case(EV_REQUEST_LIFE)
	{
		SetScriptResult(1500);
	}
	case(EV_REQUEST_TIMER)
	{
		SetScriptResult(60);
	}
}

task TWork
{
	ObjMove_SetPosition(objBoss,192,120);
	wait(120);
	Obj_SetValue(objBoss,"Anim",1);
	wait(120);
	Obj_SetValue(objBoss,"Anim",0);
	yield;
	Obj_SetValue(objBoss,"Anim",2);
	wait(120);
	Obj_SetValue(objBoss,"Anim",3);
	wait(120);
	Obj_SetValue(objBoss,"Anim",0);
}

task Animation_Azure(obj){
	let blink = false;
	BlinkTimer;
	ObjSprite2D_SetDestRect(obj,-32,-48,32,48);
	ObjPrim_SetTexture(obj,GetCurrentScriptDirectory() ~ "./system/azuresprite.png");
	while(!Obj_IsDeleted(obj)){
		while(Obj_GetValueD(obj,"Anim",0) == 0 && !Obj_IsDeleted(obj)){
			if(blink){
				blink = false;
				ObjSprite2D_SetSourceRect(obj,256,0,320,96);
				wait(6);
				ObjSprite2D_SetSourceRect(obj,0,0,64,96);
				wait(6);
			}
			else{
				ObjSprite2D_SetSourceRect(obj,0,0,64,96);
				wait(12);
			}
			ascent(i in 1..4){
				if(Obj_GetValueD(obj,"Anim",0) != 0 || Obj_IsDeleted(obj)){break;}
				ObjSprite2D_SetSourceRect(obj,i*64,0,(i+1)*64,96);
				wait(12);
			}
		}
		if(Obj_GetValueD(obj,"Anim",0) == 1){
			ObjRender_SetScaleX(obj,-1);
			Obj_SetValue(obj,"Anim",2);
		}
		if(Obj_GetValueD(obj,"Anim",0) == 2 && !Obj_IsDeleted(obj)){
			ascent(i in 0..4){
				ObjSprite2D_SetSourceRect(obj,i*64,96,(i+1)*64,192);
				wait(6);
			}
			while(Obj_GetValueD(obj,"Anim",0) == 2 && !Obj_IsDeleted(obj)){
				if(blink){
					blink = false;
					ObjSprite2D_SetSourceRect(obj,256,96,320,192);
					wait(6);
					ObjSprite2D_SetSourceRect(obj,192,96,256,192);
				}
				yield;
			}
			descent(i in 0..4){
				ObjSprite2D_SetSourceRect(obj,i*64,96,(i+1)*64,192);
				wait(6);
			}
			ObjRender_SetScaleX(obj,1);
		}
		if(Obj_GetValueD(obj,"Anim",0) == 3 && !Obj_IsDeleted(obj)){
			ascent(i in 0..5){
				ObjSprite2D_SetSourceRect(obj,i*64,192,(i+1)*64,288);
				wait(6);
			}
			while(Obj_GetValueD(obj,"Anim",0) == 3 && !Obj_IsDeleted(obj)){yield;}
			descent(i in 0..4){
				ObjSprite2D_SetSourceRect(obj,i*64,192,(i+1)*64,288);
				wait(6);
			}
		}
	}
	

	task BlinkTimer{
		while(!Obj_IsDeleted(objBoss)){
			wait(floor(rand(240,480)));
			blink = true;
		}
	}
}

//ew
/*
let bossMoving = false;
let bossAttacking = false;
let bossIdling = true;
let bossBlink = false;

task AnimateAzure(obj){
	let blink = false;
	let step = 0;
	ObjSprite2D_SetDestRect(obj,-32,-48,32,48);
	ObjPrim_SetTexture(obj,GetCurrentScriptDirectory() ~ "./img/azuresprite.png");
	BlinkTimer;
	while(!Obj_IsDeleted(obj)){
		ascent(i in 0..4){
			if(bossIdling){
				if(i == 0 && bossBlink){
					bossBlink = false;
					ObjSprite2D_SetSourceRect(obj,256,0,320,96);
					wait(10);
					ObjSprite2D_SetSourceRect(obj,i*64,0,(i+1)*64,96);
					wait(5);
				}
				else{
					ObjSprite2D_SetSourceRect(obj,i*64,0,(i+1)*64,96);
					wait(15);
				}
			}
		}
		while(!bossIdling){yield;}
	}

	task BlinkTimer{
		while(!Obj_IsDeleted(obj)){
			wait(floor(rand(200,400)));
			bossBlink = true;
		}
	}
}

task MoveAzure(obj,dir){
	bossMoving = true;
	bossIdling = false;
	ObjRender_SetScaleX(obj,dir);
	ascent(i in 0..4){
		ObjSprite2D_SetSourceRect(obj,i*64,96,(i+1)*64,192);
		wait(6);
	}
	while(bossMoving){
		if(bossBlink){
			bossBlink = false;
			ObjSprite2D_SetSourceRect(obj,256,96,320,192);
			wait(10);
			ObjSprite2D_SetSourceRect(obj,192,96,256,192);
		}
		yield;
	}
	descent(i in 0..4){
		ObjSprite2D_SetSourceRect(obj,i*64,96,(i+1)*64,192);
		wait(6);
	}
	ObjRender_SetScaleX(obj,1);
	bossIdling = true;
}

task AzureAttack(obj){
	while(bossMoving){yield;}
	bossAttacking = true;
	bossIdling = false;
	ascent(i in 0..5){
		ObjSprite2D_SetSourceRect(obj,i*64,192,(i+1)*64,288);
		wait(6);
	}
	while(bossAttacking){yield;}
	descent(i in 0..4){
		ObjSprite2D_SetSourceRect(obj,i*64,192,(i+1)*64,288);
		wait(6);
	}
	bossIdling = true;
}
*/
task TEnd
{
	while(ObjEnemy_GetInfo(objBoss, INFO_LIFE) > 0)
	{
		yield;
	}

	DeleteShotAll(TYPE_ALL, TYPE_ITEM);
	Obj_Delete(objBoss);

	loop(30){yield;}

	CloseScript(GetOwnScriptID());
}

function wait(n){loop(n){yield;}}